<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Contador y Datos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        /*         table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table,
        th,
        td {
            border: 1px solid #ddd;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
        } */

        input[type="number"] {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }

        select {
            width: 100%;
            padding: 8px;
        }

        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .resultado {
            font-weight: bold;
            margin-top: 15px;
            font-size: 18px;
        }

        .contador {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }

        .oculto {
            display: none;
        }

        .mensaje-final {
            text-align: center;
            font-size: 24px;
            color: #ff0000;
            margin-top: 30px;
        }

        body {
            font-family: sans-serif;
            margin: 2rem;
        }

        select,
        input[type="number"],
        button {
            margin: 0.5rem;
            padding: 0.4rem;
        }

        table {
            border-collapse: collapse;
            margin-top: 1rem;
            width: 35%;
        }

        th,
        td {
            border: 1px solid #ccc;
            text-align: center;
            padding: 1;
            height: 20px;
        }

        .gross {
            width: 30px;
            /* o menos si quer√©s */
            text-align: center;
        }

        .birdie {
            background-color: #87CEFA;
            width: 30px;
        }

        .eagle {
            background-color: #FFFF99;
            width: 30px;
        }

        .bogey {
            background-color: #D2B48C;
            width: 30px;
        }

        .double {
            background-color: #FF7F7F;
            width: 30px;
        }

        .cargado {
            color: gray;
            font-style: italic;
        }

        /* esto elimina las flechitas que aumentan y disminuyen el numero */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>

<body>
    <h1>Sistema de Contador y Datos</h1>
    <div style="font-size: 12px; display: flex; align-items: center; gap: 5px;">
        <label for="ultFecha">√öltima:</label>
        <input id="ultFecha" type="text" placeholder="..." disabled>
        <label for="ultNumero">N¬∞</label>
        <input id="ultNumero" type="number" placeholder=".." maxlength="3" disabled style="width: 5ch">
    </div>

    <span style="font-size: 14px;">
        <div id="inicio">
            <!-- <div style="margin-bottom: 1em"> -->
            <label for="fecha">Fecha:</label>
            <input type="date" id="fecha" />

            <div id="selecCanchaDiv" style="display: none;">
                <label for="canchaSelect">Cancha:</label>
                <select id="canchaSelect"></select>
            </div>

            <div id="infoTotalJugDiv" style="display: none;">
                <label for="totJugadores">Total Jugadores:</label>
                <input type="number" id="totJugadores" style="width: 25px" min="3" max="12">
            </div>
        </div>
    </span>

    <!-- Contador
    <div class="contador" id="contadorDisplay">
        Falta cargar: <span id="contador"></span>
    </div> -->

    <!-- Paso 1: Selecci√≥n de nombre -->
    <div class="container" id="paso1">

        <!-- Contador -->
        <div class="contador" id="contadorDisplay">
            Falta cargar: <span id="contador"></span>
        </div>

        <h3>Paso 1: Seleccionar jugador</h3>

        <!-- <div id="faltaCargarDiv" style="display: none; margin-bottom: 1em;">
            <label for="faltan">Faltan:</label>
            <input type="number" id="faltan" style="width: 25px;">
        </div> -->
        <!-- Segunda l√≠nea: Jugador (siempre visible), y oculto inicialmente handicap + tarjeta -->
        <div style="display: flex; gap: 10px;">
            <div style="margin-bottom: 1em;">
                <label for="jugadorSelect">Jugador</label>
                <select id="jugadorSelect">
                    <option value="">Seleccionar</option>
                    <option value="Diegui">Diegui</option>
                    <option value="Edu">Edu</option>
                    <option value="Fer">Fer</option>
                    <option value="Gaby">Gaby</option>
                    <option value="Joaco">Joaco</option>
                    <option value="Juancho">Juancho</option>
                    <option value="Julito">Julito</option>
                    <option value="Negro">Negro</option>
                    <option value="Panza">Panza</option>
                    <option value="Presi">Presi</option>
                    <option value="Sensei">Sensei</option>
                    <option value="Torni">Torni</option>
                </select>
            </div>

        </div>
        <!-- <select id="selectNombre">
            <option value="">-- Seleccione un nombre --</option>
            <option value="Juan">Juan</option>
            <option value="Mar√≠a">Mar√≠a</option>
            <option value="Pedro">Pedro</option>
            <option value="Ana">Ana</option>
            <option value="Luis">Luis</option>
        </select> -->
        <button id="btnContinuar">Continuar</button>
    </div>

    <!-- Paso 2: Tabla para ingresar datos -->
    <div class="container oculto" id="paso2">
        <form id="tarjetaForm">
            <h2>Paso 2: Ingrese los datos para <span id="nombreSeleccionado"></span></h2>

            <!-- <div id="faltaCargarDiv" style="display: none; margin-bottom: 1em;">
                <label for="faltan">Faltan:</label>
                <input type="number" id="faltan" style="width: 25px;">
            </div> -->

            <!-- Handicap (oculto inicialmente) -->
            <div id="handicapContainer" style="display: none; margin-bottom: 1em;">
                <label for="handicap">Handicap</label>
                <input type="number" id="handicap" style="width: 25px;">
            </div>

            <!-- Tarjeta de score (oculta inicialmente) -->
            <div id="tarjetaContainer" style="display: block;">
                <!-- Tabla de scores -->
                <table id="scoreTable">
                    <thead>
                        <tr>
                            <th>Hoyo</th>
                            <th>Par</th>
                            <th>Hcp</th>
                            <th>Golpes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="totales" style="display: flex; gap: 20px;">
                <p>Ida: <span id="totalGross1to9"><strong>0</strong></span></p>
                <p>Vuelta: <span id="totalGross10to18"><strong>0</strong></span></p>
                <p>Gross: <span id="totalGross"><strong>0</strong></span></p>
                <p>Neto: <span id="totalNeto"><strong>0</strong></span></p>
                <p>Hoyos: <span id="totalHoyos"><strong>0</strong></span></p>
            </div>

            <button id="guardarBtn" onclick="return guardarResultados()" style="display:none">Guardar
                Resultados</button>
        </form>

        <table>
            <thead>
                <tr>
                    <th>Fila</th>
                    <th>Valor</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Dato 1</td>
                    <td><input type="number" id="dato1" min="0"></td>
                </tr>
                <tr>
                    <td>Dato 2</td>
                    <td><input type="number" id="dato2" min="0"></td>
                </tr>
                <tr>
                    <td>Dato 3</td>
                    <td><input type="number" id="dato3" min="0"></td>
                </tr>
            </tbody>
        </table>
        <button id="btnCalcular">Calcular Suma</button>
    </div>

    <!-- Paso 3: Mostrar resultados -->
    <div class="container oculto" id="paso3">
        <h2>Paso 3: Resultados</h2>
        <div>
            <p>Nombre seleccionado: <strong id="resultadoNombre"></strong></p>
            <p>Datos ingresados:</p>
            <ul>
                <li>Dato 1: <span id="resultadoDato1"></span></li>
                <li>Dato 2: <span id="resultadoDato2"></span></li>
                <li>Dato 3: <span id="resultadoDato3"></span></li>
            </ul>
            <div class="resultado">
                Suma total: <span id="sumaDatos">0</span>
            </div>
        </div>
        <button id="btnReiniciar">Borrar datos y continuar</button>
    </div>

    <!-- Mensaje final -->
    <div class="oculto mensaje-final" id="mensajeFinal">
        El contador ha llegado a cero. El proceso ha finalizado.
    </div>

    <script type="module">
        // Variables globales
        let contador; // Inicializamos el contador

        // Elementos DOM
        const contadorElement = document.getElementById('contador');
        const paso1 = document.getElementById('paso1');
        const paso2 = document.getElementById('paso2');
        const paso3 = document.getElementById('paso3');
        const selectNombre = document.getElementById('selectNombre');
        const btnContinuar = document.getElementById('btnContinuar');
        const btnCalcular = document.getElementById('btnCalcular');
        const btnReiniciar = document.getElementById('btnReiniciar');
        const nombreSeleccionado = document.getElementById('nombreSeleccionado');
        const resultadoNombre = document.getElementById('resultadoNombre');
        const dato1Input = document.getElementById('dato1');
        const dato2Input = document.getElementById('dato2');
        const dato3Input = document.getElementById('dato3');
        const resultadoDato1 = document.getElementById('resultadoDato1');
        const resultadoDato2 = document.getElementById('resultadoDato2');
        const resultadoDato3 = document.getElementById('resultadoDato3');
        const sumaDatos = document.getElementById('sumaDatos');
        const mensajeFinal = document.getElementById('mensajeFinal');
        const contadorDisplay = document.getElementById('contadorDisplay');

        const fecha = document.getElementById('fecha');
        const selecCanchaDiv = document.getElementById('selecCanchaDiv');
        const cancha = document.getElementById('canchaSelect');
        const totJugadores = document.getElementById('totJugadores');
        const totalJugDiv = document.getElementById('infoTotalJugDiv');

        let hoyos = [];
        let cargadas = 0;
        let faltan = 0;
        let nombre = '';

        // paso1.classList.add('oculto');
        async function funcionInicial() {
            return new Promise((resolve) => {
                paso1.classList.add('oculto');

                buscaUltimaFecha().then((ultimaFecha) => {
                    if (ultimaFecha) {
                        document.getElementById("ultFecha").value = ultimaFecha.textoFecha;
                        document.getElementById("ultNumero").value = ultimaFecha.fec;
                        let fec = ultimaFecha.fec;
                        let fecFullTabla = ultimaFecha.fechaFull;
                    } else {
                        alert("No se encontr√≥ ninguna fecha");
                    }
                });

                cargarCanchas();

                fecha.addEventListener('change', () => {
                    if (fecha.value !== '') {
                        selecCanchaDiv.style.display = 'block';
                    }
                });

                cancha.addEventListener('change', async () => {
                    if (cancha.value !== '') {
                        infoTotalJugDiv.style.display = 'block';
                    } else {
                        infoTotalJugDiv.style.display = 'none';
                    }

                    // document.getElementById('canchaSelect').addEventListener('change', async () => {
                    const canchaId = document.getElementById('canchaSelect').value;
                    // console.log(`valor de canchaId ${canchaId}`)
                    const res = await fetch(`/api/hoyos/${canchaId}`);
                    hoyos = await res.json();

                    if (!Array.isArray(hoyos)) {
                        alert("No se pudieron cargar los hoyos de esta cancha.");
                        return;
                    }

                    renderTabla();
                });

                totJugadores.addEventListener('change', () => {
                    const valor = parseInt(totJugadores.value);

                    if (isNaN(valor) || valor < 3 || valor > 12) {
                        alert('El n√∫mero de jugadores debe estar entre 6 y 12.');
                        totJugadores.focus();
                        return; // detener el proceso
                    }

                    document.getElementById('fecha').disabled = true;
                    document.getElementById('canchaSelect').disabled = true;
                    document.getElementById('totJugadores').disabled = true;

                    // primeraTablaFS.style.display = 'block';

                    contador = valor;
                    // contadorElement.textContent = faltan;  // <-- AHORA S√ç SE ACTUALIZA BIEN
                    // const restantes = faltan - cargadas;
                    // document.getElementById('faltan').value = faltan;
                    // document.getElementById('faltan').disabled = true;

                    // primeraTablaFS.style.display = 'block';
                    // document.getElementById('faltaCargarDiv').style.display = 'block';

                    // marcarJugadoresConTarjeta();

                    document.getElementById('fecha').disabled = true;
                    document.getElementById('canchaSelect').disabled = true;
                    document.getElementById('totJugadores').disabled = true;

                    paso1.classList.remove('oculto'); // Se muestra paso1 cuando ya se valid√≥ todo
                    resolve();

                })
            });
        };

        async function iniciarApp() {
            await funcionInicial();           // Espera hasta que el usuario seleccione fecha y cancha
            // document.getElementById('inicio').classList.add('oculto'); // Oculta paso inicial
            console.log(`llego hasta aca ${faltan}`)
            paso1.classList.remove('oculto'); // Muestra paso 1
        }

        await iniciarApp();

        console.log('estamos por aca')
        // Actualizar el contador inicial
        contadorElement.textContent = contador;

        // Evento para continuar despu√©s de seleccionar nombre
        btnContinuar.addEventListener('click', function () {

            // marcarJugadoresConTarjeta();
            // const jugadorSeleccionado = this.value;

            const jugadorSeleccionado = jugadorSelect.value

            if (!jugadorSeleccionado) {
                // Si no hay jugador seleccionado, ocultar los contenedores
                document.getElementById('handicapContainer').style.display = 'none';
                document.getElementById('tarjetaContainer').style.display = 'none';
                return;
            }

            // Mostrar los contenedores de handicap y tarjeta
            document.getElementById('handicapContainer').style.display = 'block';
            document.getElementById('tarjetaContainer').style.display = 'block';
            // document.getElementById('faltan').disabled = true;

            //    // Asegurarnos que primeraTablaFS sigue visible
            //     document.getElementById('primeraTablaFS').style.display = 'block';

            // Configurar evento para c√°lculo de totales
            document.getElementById('tarjetaForm').addEventListener('input', calcularTotales);

            // if (faltan === 0) {
            //     document.getElementById('jugadorSelect').disabled = true;
            //     alert("Se completaron todas las tarjetas.");
            // }

            // const nombre = selectNombre.value;
            nombre = jugadorSeleccionado;
            if (!nombre) {
                alert('Por favor, seleccione un nombre');
                return;
            }

            // Mostrar el nombre seleccionado
            nombreSeleccionado.textContent = nombre;
            // document.getElementById('faltaCargarDiv').style.display = 'block';

            // Ocultar paso 1 y mostrar paso 2
            paso1.classList.add('oculto');
            paso2.classList.remove('oculto');
        });

        // Evento para calcular la suma
        btnCalcular.addEventListener('click', function () {
            // Obtener valores
            const valor1 = parseFloat(dato1Input.value) || 0;
            const valor2 = parseFloat(dato2Input.value) || 0;
            const valor3 = parseFloat(dato3Input.value) || 0;

            // Verificar que todos los datos est√©n completos
            if (!dato1Input.value || !dato2Input.value || !dato3Input.value) {
                alert('Por favor, complete todos los datos');
                return;
            }

            // Calcular suma
            const suma = valor1 + valor2 + valor3;

            // Mostrar resultados
            resultadoNombre.textContent = nombre;
            resultadoDato1.textContent = valor1;
            resultadoDato2.textContent = valor2;
            resultadoDato3.textContent = valor3;
            sumaDatos.textContent = suma;

            // Ocultar paso 2 y mostrar paso 3
            paso2.classList.add('oculto');
            paso3.classList.remove('oculto');
        });

        // Evento para reiniciar el proceso
        btnReiniciar.addEventListener('click', function () {
            // Restar 1 al contador
            // contador--;
            contadorElement.textContent = contador;

            // Verificar si el contador lleg√≥ a cero
            if (contador <= 0) {
                // Ocultar todos los pasos y mostrar mensaje final
                paso1.classList.add('oculto');
                paso2.classList.add('oculto');
                paso3.classList.add('oculto');
                contadorDisplay.classList.add('oculto');
                mensajeFinal.classList.remove('oculto');
                return;
            }

            // Reiniciar formulario
            // selectNombre.value = '';
            dato1Input.value = '';
            dato2Input.value = '';
            dato3Input.value = '';

            // Limpiar campos
            document.getElementById('jugadorSelect').value = '';
            document.getElementById('handicap').value = '';

            // Resetear los totales
            document.getElementById('totalGross1to9').innerHTML = '<strong>0</strong>';
            document.getElementById('totalGross10to18').innerHTML = '<strong>0</strong>';
            document.getElementById('totalGross').innerHTML = '<strong>0</strong>';
            document.getElementById('totalNeto').innerHTML = '<strong>0</strong>';

            // Limpiar tabla de score
            renderTabla();

            contador--;

            // Volver al paso 1
            paso3.classList.add('oculto');
            paso1.classList.remove('oculto');
        });


        //-----------------------------------------
        // ü•é  calcularTotales               
        //-----------------------------------------
        function calcularTotales() {
            // Obtener los valores de los hoyos
            const hoyos = Array.from(document.querySelectorAll('.gross'));

            // console.log('Cantidad de inputs .gross:', hoyos.length); // Verifica que sean 18
            const handicap = parseInt(document.getElementById('handicap').value) || 0;
            if (!handicap > 0) {
                alert("falta informar handicap")
                return
            }

            const hoyosConValor = hoyos.filter(input => parseInt(input.value) > 0).length;

            // Sumar Gross de los hoyos (1-9 y 10-18)
            const gross1to9 = hoyos.slice(0, 9).reduce((acc, input) => acc + (parseInt(input.value) || 0), 0);
            const gross10to18 = hoyos.slice(9, 18).reduce((acc, input) => acc + (parseInt(input.value) || 0), 0);

            // Calcular el Total Gross (1-18)
            const totalGross = gross1to9 + gross10to18;

            // Calcular el Total Neto (Gross Total - Handicap)
            const totalNeto = totalGross - handicap;

            // Actualizar los valores de los totales en el HTML
            const totalGrossElem = document.getElementById('totalGross1to9');
            totalGrossElem.textContent = gross1to9;
            totalGrossElem.style.fontSize = '18px';
            totalGrossElem.style.fontWeight = 'bold';
            const totalGrossElem2 = document.getElementById('totalGross10to18');
            totalGrossElem2.textContent = gross10to18;
            totalGrossElem2.style.fontSize = '18px';
            totalGrossElem2.style.fontWeight = 'bold';
            // document.getElementById('totalGross10to18').textContent = gross10to18;
            const totalGrossElem3 = document.getElementById('totalGross');
            totalGrossElem3.textContent = totalGross;
            totalGrossElem3.style.fontSize = '18px';
            totalGrossElem3.style.fontWeight = 'bold';
            // document.getElementById('totalGross').textContent = totalGross;
            const totalGrossElem4 = document.getElementById('totalNeto');
            totalGrossElem4.textContent = totalNeto;
            totalGrossElem4.style.fontSize = '20px';
            totalGrossElem4.style.fontWeight = 'bold';
            totalGrossElem4.style.color = 'red';
            // document.getElementById('totalNeto').textContent = totalNeto;
            const totalGrossElem5 = document.getElementById('totalHoyos');
            totalGrossElem5.textContent = hoyosConValor;
            totalGrossElem5.style.fontSize = '18px';
            totalGrossElem5.style.fontWeight = 'bold';

            // Activar el bot√≥n de guardar si todos los hoyos tienen valores
            const allFieldsFilled = hoyos.every(input => {
                const value = input.value.trim();
                return value !== "" && Number(value) > 0;
            });
            const validGross = totalGross > 0 && totalNeto > 0;
            const btn = document.getElementById('guardarBtn');
            // document.getElementById('guardarBtn').disabled = !(allFieldsFilled && validGross);
            if (allFieldsFilled && validGross) {
                btn.style.display = 'inline-block';
            }
        }

        /*---------------------------------------
        // üî∏ ASYNC BUSCA ULTIMA FECHA               
        -----------------------------------------*/
        async function buscaUltimaFecha() {
            try {
                const response = await fetch(`/leerUltimaFecha`);

                if (response.ok) {
                    const data = await response.json();
                    return data; // Devuelve los datos obtenidos si la respuesta es exitosa
                } else {
                    console.error(
                        "Error en la respuesta:",
                        response.status,
                        response.statusText
                    );
                    return null;
                }
            } catch (error) {
                console.error("Error en la solicitud:", error);
                return null;
            }
        }

        //-----------------------------------------------------
        // ü•é  cargarCanchas            
        //-----------------------------------------------------
        async function cargarCanchas() {
            const res = await fetch('/api/canchas');
            const data = await res.json();
            const select = document.getElementById('canchaSelect');
            select.innerHTML = '';

            const optInicial = document.createElement('option');
            optInicial.value = '';
            optInicial.textContent = 'Seleccionar';
            optInicial.disabled = true;
            optInicial.selected = true;
            select.appendChild(optInicial);

            data.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.nombre;
                select.appendChild(opt);
            });
        }

        //-----------------------------------------
        // ü•é  renderTabla               
        //-----------------------------------------
        function renderTabla() {
            const tbody = document.querySelector('#scoreTable tbody');
            tbody.innerHTML = '';

            hoyos.forEach(h => {
                const tr = document.createElement('tr');

                tr.innerHTML = `
            <td>${h.hoyo}</td>
            <td>${h.par}</td>
            <td>${h.handicap}</td>
            <td><input type="number" class="gross" min="1"></td>
        `;

                // Agregar el tr a la tabla
                tbody.appendChild(tr);

                // Ahora seleccionamos el input que acabamos de agregar
                const input = tr.querySelector('input.gross');

                // Y le asignamos el evento onchange
                input.addEventListener('change', function () {
                    actualizarColor(this, h.par);
                });
            });
        }
        /* Cuando us√°s innerHTML, los eventos inline como onchange="..." no funcionan si las funciones est√°n encapsuladas (como en type="module").
        
        Al agregar los eventListener con JS, trabaj√°s en el mismo √°mbito del m√≥dulo, donde las funciones s√≠ est√°n accesibles. */


        //-----------------------------------------
        // ü•é  actualizarColor              
        //-----------------------------------------
        function actualizarColor(input, par) {
            const valor = parseInt(input.value);
            input.className = '';

            if (!isNaN(valor)) {
                const diff = valor - par;
                input.classList.add('gross');
                if (diff === -2) input.classList.add('eagle');
                else if (diff === -1) input.classList.add('birdie');
                else if (diff === 1) input.classList.add('bogey');
                else if (diff >= 2) input.classList.add('double');
            }
        }


    </script>
</body>

</html>