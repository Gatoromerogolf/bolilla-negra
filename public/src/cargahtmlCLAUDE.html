<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link href="../styles/styleblog.css" rel="stylesheet">
    <link href="../styles/styleventana.css" rel="stylesheet"> -->
    <title>Sistema de Contador y Datos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 5px;
        }

        .container {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        input[type="number"] {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }

        /* select {
            width: 100%;
            padding: 8px;
        } */

        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .resultado {
            font-weight: bold;
            margin-top: 15px;
            font-size: 18px;
        }

        .contador {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }

        .oculto {
            display: none;
        }

        .mensaje-final {
            text-align: center;
            font-size: 24px;
            color: #ff0000;
            margin-top: 30px;
        }

        body {
            font-family: sans-serif;
            margin: 1rem;
            line-height: 1;
            /* Podés probar con 1.1 o 1 también */
        }

        #inicio label,
        #inicio input,
        #inicio select {
            line-height: 1.1;
            margin-bottom: 2px;
        }

        select,
        input[type="number"],
        button {
            margin: 0.5rem;
            padding: 0.4rem;
        }

        #canchaSelect {
            width: auto;
            min-width: 150px;
            /* O el valor que te parezca */
            max-width: 200px;
        }

        /* table {
            border-collapse: collapse;
            margin-top: 1rem;
            width: 60%;
            font-size: 13px;
        }

        th,
        td {
            border: 1px solid #ccc;
            text-align: center;
            padding: 1px 2px;
            line-height: 1;
            height: 10px;
            font-size: 11px;

        }

        td input {
            padding: 1px 2px;
            font-size: 12px;
            line-height: 1;
            height: 12px;
            width: 10px;
            box-sizing: border-box;
        } */

        .gross {
            width: 26px;
            /* Ideal para 2 dígitos */
            text-align: center;
            padding: 1px;
            overflow: hidden;
        }

        .gross input {
            width: 100%;
            font-size: 12px;
            padding: 1px;
            line-height: 1;
            height: 16px;
            box-sizing: border-box;
            text-align: center;
        }

        .birdie {
            background-color: #e9f356;
            width: 30px;
        }

        .eagle {
            background-color: #4fe2ef;
            width: 30px;
        }

        .bogey {
            background-color: #d7953f;
            width: 30px;
        }

        .double {
            background-color: #f43939;
            width: 30px;
        }

        .triple {
            background-color: #463f3f;
            color: white;
            width: 30px;
        }

        .cargado {
            color: gray;
            font-style: italic;
        }

        /* esto elimina las flechitas que aumentan y disminuyen el numero */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        /*  estilos segun claude */
        /* Estilos generales para la tabla */
        #scoreTable {
            width: 80%;
            border-collapse: collapse;
            font-size: 13px;
            /* Reducido de 14px */
            margin: 0 auto;
            background-color: #f9f9f9;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            table-layout: fixed;
            /* Asegura anchos fijos */
        }

        /* Encabezados de la tabla */
        #scoreTable thead {
            background-color: #3a7734;
            /* Color verde golf */
            color: white;
        }

        #scoreTable th {
            padding: 5px 2px;
            /* Reducido de 8px 4px */
            font-weight: bold;
            text-align: center;
            font-size: 12px;
            height: 20px;
            /* Altura explícita para encabezados */
        }

        /* Celdas de la tabla */
        #scoreTable td {
            padding: 2px 2px;
            /* Reducido de 6px 4px */
            text-align: center;
            border-bottom: 1px solid #ddd;
            height: 24px;
            /* Altura explícita para celdas */
            line-height: 1;
            /* Reducir espacio de línea */
        }

        /* Alterna colores de fondo para filas para mejor legibilidad */
        #scoreTable tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        /* Estilo para hoyo */
        #scoreTable td:nth-child(1) {
            width: 25%;
            font-weight: bold;
        }

        /* Estilo para par */
        #scoreTable td:nth-child(2) {
            width: 25%;
        }

        /* Estilo para hcp */
        #scoreTable td:nth-child(3) {
            width: 25%;
            color: #666;
        }

        /* Estilo para la columna de golpes (con clase gross) */
        #scoreTable td.gross {
            width: 20%;
            background-color: #f8f8ff;
            position: relative;
        }

        /* Estilo para input en la columna de golpes */
        #scoreTable td.gross input {
            width: 80%;
            padding: 2px 2px;
            /* Reducido de 6px 2px */
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
            height: 18px;
            /* Altura explícita para inputs */
        }

        /* Estilo para filas activas o en foco */
        #scoreTable tr.active {
            background-color: #e6f2e6 !important;
        }

        /* Estilos para el contenedor */
        #tarjetaContainer {
            max-width: 100%;
            padding: 8px;
            overflow-x: hidden;
        }

        /* Mejoras para toques táctiles */
        #scoreTable td.gross input:focus {
            outline: none;
            border-color: #3a7734;
            box-shadow: 0 0 4px rgba(58, 119, 52, 0.5);
        }

        /* Estilos para pares diferentes */
        .par3 {
            color: #ff8c00;
        }

        /* Naranja para par 3 */
        .par4 {
            color: #3a7734;
        }

        /* Verde para par 4 */
        .par5 {
            color: #0066cc;
        }

        /* Azul para par 5 */

        /* Estilos responsivos para pantallas muy pequeñas */
        @media screen and (max-width: 320px) {
            #scoreTable {
                font-size: 11px;
                /* Reducido de 12px */
            }

            #scoreTable th {
                padding: 3px 1px;
                /* Reducido de 6px 2px */
                font-size: 10px;
                /* Reducido de 11px */
                height: 20px;
                /* Reducido */
            }

            #scoreTable td {
                padding: 2px 1px;
                /* Reducido de 4px 2px */
                height: 24px;
                /* Reducido */
            }

            #scoreTable td.gross input {
                font-size: 12px;
                /* Reducido de 14px */
                height: 20px;
                /* Reducido */
                padding: 1px;
            }
        }
    </style>
</head>

<body>
    <h1>Carga de tarjetas</h1>
    <div style="font-size: 13px; display: flex; align-items: center; gap: 5px;">
        <label for="ultFecha">Última:</label>
        <input id="ultFecha" type="text" placeholder="..." disabled>
        <label for="ultNumero">N°</label>
        <input id="ultNumero" type="number" placeholder=".." disabled style="width: 5ch">
    </div>

    <div id="inicio" style="font-size: 13px;">
        <div>
            <label for="fecha">Fecha:</label>
            <input type="date" id="fecha" />
        </div>

        <div id="selecCanchaDiv" style="display: none;">
            <label for="canchaSelect">Cancha:</label>
            <select id="canchaSelect"></select>
        </div>

        <div id="infoTotalJugDiv" style="display: none;">
            <label for="totJugadores">Total Jugadores:</label>
            <input type="number" id="totJugadores" style="width: 30px" min="2" max="12">
        </div>
    </div>


    <!-- Paso 1: Selección de nombre -->
    <div class="container" id="paso1">
        <!-- Contador -->
        <div class="contador" id="contadorDisplay">
            Falta cargar: <span id="contador"></span>
        </div>
        <h3>Paso 1: Seleccionar jugador</h3>
        <div style="display: flex; gap: 10px;">
            <!-- <div style="margin-bottom: 1em;"> -->
            <div>
                <select id="jugadorSelect">
                    <option value="">Seleccionar</option>
                    <option value="Diegui">Diegui</option>
                    <option value="Edu">Edu</option>
                    <option value="Fer">Fer</option>
                    <option value="Gaby">Gaby</option>
                    <option value="Joaco">Joaco</option>
                    <option value="Juancho">Juancho</option>
                    <option value="Julito">Julito</option>
                    <option value="Negro">Negro</option>
                    <option value="Panza">Panza</option>
                    <option value="Presi">Presi</option>
                    <option value="Sensei">Sensei</option>
                    <option value="Torni">Torni</option>
                </select>
            </div>
            <div>
                <button id="btnContinuar" disabled>Continuar</button>
            </div>
        </div>
    </div>

    <!-- Paso 2: Tabla para ingresar datos -->
    <div class="container oculto" id="paso2">
        <form id="tarjetaForm">
            <h3>Paso 2: Ingresar datos de <span id="nombreSeleccionado"></span></h3>

            <!-- Handicap (oculto inicialmente) -->
            <div style="display: flex; gap: 2px;">
                <div id="handicapContainer" style="display: none; font-size: 13px" ;>
                    <label for="handicap">Handicap</label>
                    <input type="number" id="handicap" style="width: 30px;">
                </div>

                <!-- Tarjeta de score (oculta inicialmente) -->
                <div id="tarjetaContainer" style="display: block;">
                    <!-- Tabla de scores -->
                    <table id="scoreTable">
                        <thead>
                            <tr>
                                <th>Hoyo</th>
                                <th>Par</th>
                                <th>Hcp</th>
                                <th>Golpes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div id="totales" style="display: flex; gap: 20px;">
                <p>Ida: <span id="totalGross1to9"><strong>0</strong></span></p>
                <p>Vuelta: <span id="totalGross10to18"><strong>0</strong></span></p>
                <p>Gross: <span id="totalGross"><strong>0</strong></span></p>
                <p>Neto: <span id="totalNeto"><strong>0</strong></span></p>
                <p>Hoyos: <span id="totalHoyos"><strong>0</strong></span></p>
            </div>

            <!-- <button id="guardarBtn" onclick="return guardarResultados()" style="display:none">Guardar
                Resultados</button> -->

            <button id="btnCalcular" type="button" style="display:none" disabled>Continuar</button>
        </form>
    </div>

    <!-- Paso 3: Mostrar resultados -->
    <div class="container oculto" id="paso3">
        <h2>Paso 3: Resultados</h2>
        <div>
            <p>Jugador: <strong id="resultadoNombre"></strong></p>

            <div id="totales" style="display: flex; gap: 20px;">
                <p>Ida: <span id="totalGross1to92"><strong>0</strong></span></p>
                <p>Vuelta: <span id="totalGross10to182"><strong>0</strong></span></p>
                <p>Gross: <span id="totalGross2"><strong>0</strong></span></p>
                <p>Neto: <span id="totalNeto2"><strong>0</strong></span></p>
            </div>
            <div style="display: flex; gap: 20px;">
                <p>Handicap: </p>
                <p>Jugado: <span id="hcpJugado"><strong></strong></span></p>
                <p>Bolilla: <span id="hcpBolilla"><strong></strong></span></p>
                <p>Diferencia: <span id="difHandicap"><strong></strong></span></p>

            </div>

            <button id="btnReiniciar">Guardar datos y continuar</button>
        </div>
    </div>

    <!-- Mensaje final -->
    <div class="oculto mensaje-final" id="mensajeFinal">
        <p>Se finalizó la carga.</p>
        <p>Felicitaciones a la HCDT!!!!</p>
    </div>


    <script type="module">
        // Variables globales
        let contador; // Inicializamos el contador

        // Elementos DOM
        const contadorElement = document.getElementById('contador');
        const paso1 = document.getElementById('paso1');
        const paso2 = document.getElementById('paso2');
        const paso3 = document.getElementById('paso3');
        const selectNombre = document.getElementById('selectNombre');
        const jugadorSelect = document.getElementById('jugadorSelect');
        const btnContinuar = document.getElementById('btnContinuar');
        const btnCalcular = document.getElementById('btnCalcular');
        const btnReiniciar = document.getElementById('btnReiniciar');
        const nombreSeleccionado = document.getElementById('nombreSeleccionado');
        const resultadoNombre = document.getElementById('resultadoNombre');
        const mensajeFinal = document.getElementById('mensajeFinal');
        const contadorDisplay = document.getElementById('contadorDisplay');
        const tarjetaForm = document.getElementById('tarjetaForm');

        const fecha = document.getElementById('fecha');
        const selecCanchaDiv = document.getElementById('selecCanchaDiv');
        const cancha = document.getElementById('canchaSelect');
        const totJugadores = document.getElementById('totJugadores');
        const totalJugDiv = document.getElementById('infoTotalJugDiv');

        let hoyos = [];
        let cargadas = 0;
        let faltan = 0;
        let nombre = '';

        let handicap = 0;
        let handicapBolilla = 0;
        let handicapDiferencia = 0;
        let gross1to9 = 0;
        let gross10to18 = 0;
        let totalGross = 0;
        let totalNeto = 0;

        let valoresGross = [];

        // paso1.classList.add('oculto');
        async function funcionInicial() {
            return new Promise((resolve) => {
                paso1.classList.add('oculto');

                buscaUltimaFecha().then((ultimaFecha) => {
                    if (ultimaFecha) {
                        document.getElementById("ultFecha").value = ultimaFecha.textoFecha;
                        document.getElementById("ultNumero").value = ultimaFecha.fec;
                        let fec = ultimaFecha.fec;
                        let fecFullTabla = ultimaFecha.fechaFull;
                    } else {
                        alert("No se encontró ninguna fecha");
                    }
                });

                cargarCanchas();

                fecha.addEventListener('change', () => {
                    if (fecha.value !== '') {
                        selecCanchaDiv.style.display = 'block';
                    }
                });

                cancha.addEventListener('change', async () => {
                    if (cancha.value !== '') {
                        infoTotalJugDiv.style.display = 'block';
                    } else {
                        infoTotalJugDiv.style.display = 'none';
                    }

                    // document.getElementById('canchaSelect').addEventListener('change', async () => {
                    const canchaId = document.getElementById('canchaSelect').value;
                    // console.log(`valor de canchaId ${canchaId}`)
                    const res = await fetch(`/api/hoyos/${canchaId}`);
                    hoyos = await res.json();

                    if (!Array.isArray(hoyos)) {
                        alert("No se pudieron cargar los hoyos de esta cancha.");
                        return;
                    }

                    renderTabla();
                });

                totJugadores.addEventListener('change', () => {
                    const valor = parseInt(totJugadores.value);

                    if (isNaN(valor) || valor < 2 || valor > 12) {
                        alert('El número de jugadores debe estar entre 6 y 12.');
                        totJugadores.focus();
                        return; // detener el proceso
                    }

                    document.getElementById('fecha').disabled = true;
                    document.getElementById('canchaSelect').disabled = true;
                    document.getElementById('totJugadores').disabled = true;

                    contador = valor;

                    // marcarJugadoresConTarjeta();

                    document.getElementById('fecha').disabled = true;
                    document.getElementById('canchaSelect').disabled = true;
                    document.getElementById('totJugadores').disabled = true;

                    paso1.classList.remove('oculto'); // Se muestra paso1 cuando ya se validó todo
                    resolve();

                })
            });
        };

        async function iniciarApp() {
            await funcionInicial();           // Espera hasta que el usuario seleccione fecha y cancha
            // document.getElementById('inicio').classList.add('oculto'); // Oculta paso inicial
            console.log(`llego hasta aca ${faltan}`)
            paso1.classList.remove('oculto'); // Muestra paso 1
        }

        await iniciarApp();

        // Actualizar el contador inicial
        contadorElement.textContent = contador;

        // Habilitar o deshabilitar el botón según la selección
        jugadorSelect.addEventListener('change', function () {
            if (this.value) {
                btnContinuar.disabled = false;
            } else {
                btnContinuar.disabled = true;
            }
        });

        // prevenir submit/enter en todo el form
        tarjetaForm.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
            }
        });

        // Evento para continuar después de seleccionar nombre
        btnContinuar.addEventListener('click', function () {

            const jugadorSeleccionado = jugadorSelect.value

            if (!jugadorSeleccionado) {
                alert('Por favor, seleccione un nombre');
                return;
            }

            // Mostrar los contenedores de handicap y tarjeta
            document.getElementById('handicapContainer').style.display = 'block';
            document.getElementById('tarjetaContainer').style.display = 'block';

            nombre = jugadorSeleccionado;

            // Mostrar el nombre seleccionado
            nombreSeleccionado.textContent = nombre;

            // Ocultar paso 1 y mostrar paso 2
            paso1.classList.add('oculto');
            paso2.classList.remove('oculto');
        });

        // Evento para calcular la suma
        btnCalcular.addEventListener('click', function () {

            const tarjetaForm = document.getElementById('tarjetaForm');

            tarjetaForm.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                }
            });

            // Mostrar resultados
            resultadoNombre.textContent = nombre;
            totalGross1to92.textContent = gross1to9;
            totalGross10to182.textContent = gross10to18;
            totalGross2.textContent = totalGross;
            totalNeto2.textContent = totalNeto;

            hcpJugado.textContent = handicap;
            handicapBolilla = totalGross - 72;
            hcpBolilla.textContent = handicapBolilla;
            handicapDiferencia = handicapBolilla - handicap;
            difHandicap.textContent = handicapDiferencia;

            // Ocultar paso 2 y mostrar paso 3
            paso2.classList.add('oculto');
            paso3.classList.remove('oculto');
        });

        // Evento para reiniciar el proceso
        btnReiniciar.addEventListener('click', function () {
            // Restar 1 al contador
            contador--;
            contadorElement.textContent = contador;

            guardarResultados();

            // Verificar si el contador llegó a cero
            if (contador <= 0) {
                // Ocultar todos los pasos y mostrar mensaje final
                paso1.classList.add('oculto');
                paso2.classList.add('oculto');
                paso3.classList.add('oculto');
                contadorDisplay.classList.add('oculto');
                mensajeFinal.classList.remove('oculto');
                return;
            }

            // Limpiar campos
            document.getElementById('jugadorSelect').value = '';
            document.getElementById('handicap').value = '';

            // Resetear los totales
            document.getElementById('totalGross1to9').innerHTML = '<strong>0</strong>';
            document.getElementById('totalGross10to18').innerHTML = '<strong>0</strong>';
            document.getElementById('totalGross').innerHTML = '<strong>0</strong>';
            document.getElementById('totalNeto').innerHTML = '<strong>0</strong>';

            // Limpiar tabla de score
            renderTabla();
            marcarJugadoresConTarjeta();

            // Volver al paso 1
            paso3.classList.add('oculto');
            paso1.classList.remove('oculto');
        });


        //-----------------------------------------
        // 🥎  calcularTotales               
        //-----------------------------------------
        function calcularTotales() {
            // Obtener los valores de los hoyos

            handicap = parseInt(document.getElementById('handicap').value) || 0;
            if (!handicap > 0) {
                alert("falta informar handicap")
                return
            }

            const inputsGross = document.querySelectorAll('.gross');

            // Calcular cuántos hoyos tienen valor válido (> 0)
            const hoyosConValor = Array.from(inputsGross).filter(input => {
                const valor = parseInt(input.value);
                return !isNaN(valor) && valor > 0;
            }).length;

            gross1to9 = 0;
            gross10to18 = 0;
            // Sumar Gross de los hoyos (1-9 y 10-18)
            inputsGross.forEach((input, index) => {
                const valor = parseInt(input.value);
                if (!isNaN(valor) && valor > 0) {
                    if (index < 9) {
                        gross1to9 += valor;
                    } else {
                        gross10to18 += valor;
                    }
                }
            });

            totalGross = gross1to9 + gross10to18;

            totalNeto = totalGross - handicap;

            const totalGrossElem = document.getElementById('totalGross1to9');
            totalGrossElem.textContent = gross1to9;
            totalGrossElem.style.fontSize = '18px';
            totalGrossElem.style.fontWeight = 'bold';
            const totalGrossElem2 = document.getElementById('totalGross10to18');
            totalGrossElem2.textContent = gross10to18;
            totalGrossElem2.style.fontSize = '18px';
            totalGrossElem2.style.fontWeight = 'bold';

            const totalGrossElem3 = document.getElementById('totalGross');
            totalGrossElem3.textContent = totalGross;
            totalGrossElem3.style.fontSize = '18px';
            totalGrossElem3.style.fontWeight = 'bold';

            const totalGrossElem4 = document.getElementById('totalNeto');
            totalGrossElem4.textContent = totalNeto;
            totalGrossElem4.style.fontSize = '20px';
            totalGrossElem4.style.fontWeight = 'bold';
            totalGrossElem4.style.color = 'red';

            const totalGrossElem5 = document.getElementById('totalHoyos');
            totalGrossElem5.textContent = hoyosConValor;
            totalGrossElem5.style.fontSize = '18px';
            totalGrossElem5.style.fontWeight = 'bold';

            // Activar el botón de guardar si todos los hoyos tienen valores
            const allFieldsFilled = Array.from(inputsGross).every(input => {
                const value = input.value.trim();
                return value !== "" && Number(value) > 0;
            });

            const validGross = totalGross > 0 && totalNeto > 0;
            // const btn = document.getElementById('guardarBtn');
            //     btn.style.display = 'inline-block';

            const btn2 = document.getElementById('btnCalcular');
            if (allFieldsFilled && validGross) {
                btn2.disabled = false; // ✅ Habilita el botón
                btn2.style.display = 'inline-block';

                // Crear el arreglo con los valores
                valoresGross = Array.from(inputsGross).map(input => Number(input.value.trim()));
                console.log(valoresGross);
            } else {
                btn2.disabled = true; // ❌ Lo deshabilita si no está todo completo
            }
        }

        //-----------------------------------------
        // 🥎  guardarResultados               
        //-----------------------------------------
        // Guardar resultados
        async function guardarResultados() {
            const jugador = document.getElementById('jugadorSelect').value;
            const cancha = parseInt(document.getElementById('canchaSelect').value);
            const fecha = document.getElementById('fecha').value;
            const hcpcancha = parseInt(document.getElementById('handicap').value);
            let gross = totalGross;
            let neto = totalNeto;
            let hcpbolilla = handicapBolilla;

            let body = {
                jugador,
                cancha,
                fecha,
                gross,
                hcpcancha,
                neto,
                hcpbolilla
            };

            console.log(`body para mandar ${body}`);

            if (!jugador || cancha == null || fecha == null || gross == null || hcpcancha == null || neto == null || hcpbolilla == null) {
                return res.status(400).json({ error: "Faltan datos para guardar el handicap" });
            }

            try {
                const response = await fetch("/handicaps", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(body),
                    credentials: "include",
                });

                if (response.ok) {

                } else {
                    const data = await response.json();
                    alert("Error: " + data.error);
                }
            } catch (error) {
                console.error("Error al guardar:", error);
            }

            // Incrementar contador de jugadores cargados
            cargadas++;
            console.log(`GuardarResultados: cargadas: ${cargadas}`);

            // 🎫🎫🎫 graba tarjeta completa 🎫🎫🎫

            const hoyos = [];
            for (let i = 0; i < valoresGross.length; i++) {
                const val = valoresGross[i];
                if (isNaN(val)) {
                    alert(`Falta cargar el hoyo ${i + 1}`);
                    return;
                }
                hoyos.push({ hoyo: i + 1, golpes: val });
            }

            body = {
                jugador,
                fecha,
                cancha,
                handicap: hcpcancha,
                hoyos
            };

            try {
                const res = await fetch('/api/tarjetas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                    credentials: "include",
                });

                if (!res.ok) {
                    throw new Error(`Error del servidor: ${res.status} ${res.statusText}`);
                }
                // alert(res.message || 'Tarjeta grabada');
            } catch (err) {
                console.error('Error al guardar resultados:', err.message);
                console.error('Stack:', err.stack);
                alert(`Error al guardar resultados: ${err.message}`);
                return; // Detener la ejecución si hay error
            }

            marcarJugadoresConTarjeta();
        }

        /*---------------------------------------
        // 🔸 ASYNC BUSCA ULTIMA FECHA               
        -----------------------------------------*/
        async function buscaUltimaFecha() {
            try {
                const response = await fetch(`/leerUltimaFecha`);

                if (response.ok) {
                    const data = await response.json();
                    return data; // Devuelve los datos obtenidos si la respuesta es exitosa
                } else {
                    console.error(
                        "Error en la respuesta:",
                        response.status,
                        response.statusText
                    );
                    return null;
                }
            } catch (error) {
                console.error("Error en la solicitud:", error);
                return null;
            }
        }

        //-----------------------------------------------------
        // 🥎  cargarCanchas            
        //-----------------------------------------------------
        async function cargarCanchas() {
            const res = await fetch('/api/canchas');
            const data = await res.json();
            const select = document.getElementById('canchaSelect');
            select.innerHTML = '';

            const optInicial = document.createElement('option');
            optInicial.value = '';
            optInicial.textContent = 'Seleccionar';
            optInicial.disabled = true;
            optInicial.selected = true;
            select.appendChild(optInicial);

            data.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.nombre;
                select.appendChild(opt);
            });
        }

        //-----------------------------------------
        // 🥎  renderTabla               
        //-----------------------------------------
        function renderTabla() {
            const tbody = document.querySelector('#scoreTable tbody');
            tbody.innerHTML = '';

            hoyos.forEach(h => {
                const tr = document.createElement('tr');

                tr.innerHTML = `
                        <td>${h.hoyo}</td>
                        <td>${h.par}</td>
                        <td>${h.handicap}</td>
                        <td><input type="number" class="gross" min="1"></td>
                    `;

                // Agregar el tr a la tabla
                tbody.appendChild(tr);

                // Ahora seleccionamos el input que acabamos de agregar
                const input = tr.querySelector('input.gross');

                // Y le asignamos el evento onchange
                input.addEventListener('change', function () {
                    actualizarColor(this, h.par);
                });
            });

            // ✅ Asociar evento automáticamente al cargar
            const inputsGross = document.querySelectorAll('.gross');
            inputsGross.forEach(input => {
                input.addEventListener('input', calcularTotales);
            });
        }
        /* Cuando usás innerHTML, los eventos inline como onchange="..." no funcionan si las funciones están encapsuladas (como en type="module").
        
        Al agregar los eventListener con JS, trabajás en el mismo ámbito del módulo, donde las funciones sí están accesibles. */


        //-----------------------------------------
        // 🥎  actualizarColor              
        //-----------------------------------------
        function actualizarColor(input, par) {
            const valor = parseInt(input.value);
            input.className = '';

            if (!isNaN(valor)) {
                const diff = valor - par;
                input.classList.add('gross');
                if (diff === -2) input.classList.add('eagle');
                else if (diff === -1) input.classList.add('birdie');
                else if (diff === 1) input.classList.add('bogey');
                else if (diff === 2) input.classList.add('double');
                else if (diff > 2) input.classList.add('triple');
            }
        }

        //-----------------------------------------
        // 🥎  marcarJugadoresConTarjeta               
        //-----------------------------------------
        async function marcarJugadoresConTarjeta() {
            const fecha = document.getElementById('fecha').value;
            const cancha = document.getElementById('canchaSelect').value;
            if (!fecha || !cancha) return;

            try {
                const res = await fetch(`/api/tarjetas/jugadores-cargados?fecha=${fecha}&cancha=${cancha}`);
                const cargados = await res.json();

                const select = document.getElementById('jugadorSelect');
                Array.from(select.options).forEach(opt => {
                    opt.classList.remove('cargado');
                    opt.disabled = false;

                    if (cargados.includes(opt.value)) {
                        opt.classList.add('cargado');
                        opt.disabled = true;
                        opt.textContent = `✅ ${opt.textContent.replace(/^✅ /, '')}`;
                    } else {
                        opt.textContent = opt.textContent.replace(/^✅ /, '');
                    }
                });

                if (cargados.includes(select.value)) {
                    select.value = '';
                }
            } catch (err) {
                console.error('Error al marcar jugadores cargados:', err);
            }
        }


    </script>
</body>

</html>