<!DOCTYPE html>
<html lang="es">

<head>
  <link href="assets/images/bn2.ico" rel="icon">
  <link href="../styles/styleblog.css" rel="stylesheet">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carga de Scores - Golf</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
    }

    select,
    input[type="number"],
    button {
      margin: 0.5rem;
      padding: 0.4rem;
    }

    table {
      border-collapse: collapse;
      margin-top: 1rem;
      width: 20%;
    }

    th,
    td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 0;
      height: 20px;
    }

    .gross {
      width: 30px;
      /* o menos si querÃ©s */
      text-align: center;
    }

    .birdie {
      background-color: #87CEFA;
      width: 30px;
    }

    .eagle {
      background-color: #FFFF99;
      width: 30px;
    }

    .bogey {
      background-color: #D2B48C;
      width: 30px;
    }

    .double {
      background-color: #FF7F7F;
      width: 30px;
    }

    .cargado {
      color: gray;
      font-style: italic;
    }

    /* esto elimina las flechitas que aumentan y disminuyen el numero */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type=number] {
      -moz-appearance: textfield;
    }
  </style>
</head>

<body>
  <div style="font-size: 12px; display: flex; align-items: center; gap: 5px;">
    <label for="ultFecha">Ãšltima:</label>
    <input id="ultFecha" type="text" placeholder="sabado 8 setiembre" disabled>
    <label for="ultNumero">NÂ°</label>
    <input id="ultNumero" type="number" placeholder="99" maxlength="3" disabled style="width: 5ch">
  </div>

  <h2>Carga de Scores</h2>

  <!-- Formulario -->
  <!-- Primera lÃ­nea: Fecha y Cancha -->
  <span style="font-size: 14px;">
    <div>
      <!-- <div style="margin-bottom: 1em"> -->
      <label for="fecha">Fecha:</label>
      <input type="date" id="fecha" />

      <label for="canchaSelect">Cancha:</label>
      <select id="canchaSelect"></select>

      <label for="totJugadores">Total Jugadores:</label>
      <input type="number" id="totJugadores" style="width: 25px">
    </div>
  </span>

  <!-- <fieldset id="primeraTabla" style="display: block"> -->
  <fieldset id="primeraTabla" style="display: block; width: 60%; margin: 0 auto;">
    <legend style="font-size: 30px;">Participantes</legend>
    <form id="tarjetaForm">
      <!-- Segunda lÃ­nea: Jugador (siempre visible), y oculto inicialmente handicap + tarjeta -->
      <div style="display: flex; gap: 20px;">
        <div style="margin-bottom: 1em;">
          <label for="jugadorSelect">Jugador</label>
          <select id="jugadorSelect">
            <option value="">Seleccionar</option>
            <option value="Diegui">Diegui</option>
            <option value="Edu">Edu</option>
            <option value="Fer">Fer</option>
            <option value="Gaby">Gaby</option>
            <option value="Joaco">Joaco</option>
            <option value="Juancho">Juancho</option>
            <option value="Julito">Julito</option>
            <option value="Negro">Negro</option>
            <option value="Panza">Panza</option>
            <option value="Presi">Presi</option>
            <option value="Sensei">Sensei</option>
            <option value="Torni">Torni</option>
          </select>
        </div>

        <!-- Handicap (oculto inicialmente) -->
        <div id="handicapContainer" style="display: none; margin-bottom: 1em;">
          <label for="handicap">Handicap</label>
          <input type="number" id="handicap" style="width: 30px;">
        </div>
      </div>


      <!-- Tarjeta de score (oculta inicialmente) -->
      <div id="tarjetaContainer" style="display: none;">
        <!-- Tabla de scores -->
        <table id="scoreTable">
          <thead>
            <tr>
              <th>Hoyo</th>
              <th>Par</th>
              <th>HCP</th>
              <th>Golpes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="totales" style="display: flex; gap: 20px;">
        <p>Ida: <span id="totalGross1to9"><strong>0</strong></span></p>
        <p>Vuelta: <span id="totalGross10to18"><strong>0</strong></span></p>
        <p>Gross: <span id="totalGross"><strong>0</strong></span></p>
        <p>Total Neto: <span id="totalNeto"><strong>0</strong></span></p>
      </div>

      <button id="guardarBtn" onclick="guardarResultados()" style="display:none">Guardar Resultados</button>
    </form>
  </fieldset>

  <script>
    // ðŸ¥ŽðŸ¥ŽðŸ¥ŽðŸ¥ŽðŸ¥ŽðŸ¥ŽðŸ¥ŽðŸ¥ŽðŸ¥ŽðŸ¥ŽðŸ¥ŽðŸ¥ŽðŸ¥ŽðŸ¥ŽðŸ¥ŽðŸ¥Ž       

    let hoyos = [];

    // Eventos iniciales
    document.getElementById('fecha').addEventListener('change', verificarTodoCompleto);
    document.getElementById('canchaSelect').addEventListener('change', verificarTodoCompleto);
    // document.getElementById('jugadorSelect').addEventListener('change', verificarTodoCompleto);

    document.getElementById('jugadorSelect').addEventListener('change', function () {
      const jugadorSeleccionado = this.value;
      const handicapContainer = document.getElementById('handicapContainer');
      const tarjetaContainer = document.getElementById('tarjetaContainer');

      if (jugadorSeleccionado) {
        handicapContainer.style.display = 'block';
        tarjetaContainer.style.display = 'block';
      } else {
        handicapContainer.style.display = 'none';
        tarjetaContainer.style.display = 'none';
      }
    });

    document.getElementById('handicap').addEventListener('input', verificarTodoCompleto);
    document.querySelector('#scoreTable').addEventListener('input', verificarTodoCompleto);

    document.getElementById('fecha').addEventListener('change', marcarJugadoresConTarjeta);
    document.getElementById('canchaSelect').addEventListener('change', marcarJugadoresConTarjeta);


//-----------------------------------------------------
// ðŸ¥Ž  cargarCanchas            
//-----------------------------------------------------
    // Cargar opciones de canchas
    async function cargarCanchas() {
      const res = await fetch('/api/canchas');
      const data = await res.json();
      const select = document.getElementById('canchaSelect');
      select.innerHTML = '';

      const optInicial = document.createElement('option');
      optInicial.value = '';
      optInicial.textContent = 'Seleccionar';
      optInicial.disabled = true;
      optInicial.selected = true;
      select.appendChild(optInicial);

      data.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.nombre;
        select.appendChild(opt);
      });
    }

//-----------------------------------------------------
// ðŸ¥Ž  getElementById('canchaSelect').addEventListener('change'            
//-----------------------------------------------------
    // Cargar hoyos de la cancha seleccionada
    document.getElementById('canchaSelect').addEventListener('change', async () => {
      const canchaId = document.getElementById('canchaSelect').value;
      if (!canchaId) return;

      const res = await fetch(`/api/hoyos/${canchaId}`);
      hoyos = await res.json();

      if (!Array.isArray(hoyos)) {
        alert("No se pudieron cargar los hoyos de esta cancha.");
        return;
      }

      renderTabla();
    });

//-----------------------------------------------------
// ðŸ¥Ž  verificarTodoCompleto             
//-----------------------------------------------------
    // Verifica si todos los campos estÃ¡n completos para mostrar el botÃ³n
    async function verificarTodoCompleto() {
      const fecha = document.getElementById('fecha').value;
      const jugador = document.getElementById('jugadorSelect').value;
      const cancha = document.getElementById('canchaSelect').value;
      const handicap = document.getElementById('handicap').value;
      const inputs = document.querySelectorAll('#scoreTable input');

      const btn = document.getElementById('guardarBtn');
      if (!fecha || !jugador || !cancha || !handicap || inputs.length !== 18) {
        btn.style.display = 'none';
        return;
      }

      for (let input of inputs) {
        if (isNaN(parseInt(input.value))) {
          btn.style.display = 'none';
          return;
        }
      }

      const res = await fetch(`/api/tarjetas/verificar?jugador=${encodeURIComponent(jugador)}&fecha=${fecha}&cancha=${cancha}`);
      const data = await res.json();

      if (data.existe) {
        btn.style.display = 'none';
        alert("Ya existe una tarjeta cargada para este jugador en esta fecha y cancha.");
      } else {
        btn.style.display = 'inline-block';
      }
    }

//-----------------------------------------
// ðŸ¥Ž  marcarJugadoresConTarjeta               
//-----------------------------------------
    // Marcar jugadores que ya tienen tarjeta cargada
    async function marcarJugadoresConTarjeta() {
      const fecha = document.getElementById('fecha').value;
      const cancha = document.getElementById('canchaSelect').value;
      if (!fecha || !cancha) return;

      try {
        const res = await fetch(`/api/tarjetas/jugadores-cargados?fecha=${fecha}&cancha=${cancha}`);
        const cargados = await res.json();

        const select = document.getElementById('jugadorSelect');
        Array.from(select.options).forEach(opt => {
          opt.classList.remove('cargado');
          opt.disabled = false;

          if (cargados.includes(opt.value)) {
            opt.classList.add('cargado');
            opt.disabled = true;
            opt.textContent = `âœ… ${opt.textContent.replace(/^âœ… /, '')}`;
          } else {
            opt.textContent = opt.textContent.replace(/^âœ… /, '');
          }
        });

        if (cargados.includes(select.value)) {
          select.value = '';
        }
      } catch (err) {
        console.error('Error al marcar jugadores cargados:', err);
      }
    }

//-----------------------------------------
// ðŸ¥Ž  renderTabla               
//-----------------------------------------
    // Renderizar la tabla de hoyos
    function renderTabla() {
      const tbody = document.querySelector('#scoreTable tbody');
      tbody.innerHTML = '';

      hoyos.forEach(h => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${h.hoyo}</td>
          <td>${h.par}</td>
          <td>${h.handicap}</td>
          <td><input type="number" class="gross" min="1" onchange="actualizarColor(this, ${h.par})"></td>
        `;
        tbody.appendChild(tr);
      });

      verificarTodoCompleto();
    }

//-----------------------------------------
// ðŸ¥Ž  actualizarColor              
//-----------------------------------------
    // Colorear segÃºn score
    function actualizarColor(input, par) {
      const valor = parseInt(input.value);
      input.className = '';

      if (!isNaN(valor)) {
        const diff = valor - par;
        input.classList.add('gross');
        if (diff === -2) input.classList.add('eagle');
        else if (diff === -1) input.classList.add('birdie');
        else if (diff === 1) input.classList.add('bogey');
        else if (diff >= 2) input.classList.add('double');
      }
    }

//-----------------------------------------
// ðŸ¥Ž  guardarResultados               
//-----------------------------------------
    // Guardar resultados
    async function guardarResultados() {
      const fecha = document.getElementById('fecha').value;
      const jugador = document.getElementById('jugadorSelect').value;
      const cancha = document.getElementById('canchaSelect').value;
      const handicap = parseInt(document.getElementById('handicap').value);

      if (!fecha || !jugador || !cancha || isNaN(handicap)) {
        return alert('Falta completar fecha, jugador, cancha o handicap');
      }

      const inputs = document.querySelectorAll('#scoreTable input');
      if (inputs.length !== 18) return alert('No hay 18 hoyos cargados');

      const hoyos = [];
      for (let i = 0; i < inputs.length; i++) {
        const val = parseInt(inputs[i].value);
        if (isNaN(val)) return alert(`Falta cargar el hoyo ${i + 1}`);
        hoyos.push({ hoyo: i + 1, golpes: val });
      }

      const body = {
        jugador,
        fecha,
        cancha: parseInt(cancha),
        handicap,
        hoyos
      };

      try {
        const res = await fetch('/api/tarjetas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const result = await res.json();
        alert(result.message || 'Tarjeta grabada');
      } catch (err) {
        console.error('Error al guardar resultados:', err);
      }

      document.getElementById('fecha').disabled = true;
      document.getElementById('canchaSelect').disabled = true;
      document.getElementById('totJugadores').disabled = true;
    }

    document.getElementById('tarjetaForm').addEventListener('input', calcularTotales);

//-----------------------------------------
// ðŸ¥Ž  calcularTotales               
//-----------------------------------------
    function calcularTotales() {
      // Obtener los valores de los hoyos
      const hoyos = Array.from(document.querySelectorAll('.gross'));

      console.log('Cantidad de inputs .gross:', hoyos.length); // Verifica que sean 18
      const handicap = parseInt(document.getElementById('handicap').value) || 0;

      // Sumar Gross de los hoyos (1-9 y 10-18)
      const gross1to9 = hoyos.slice(0, 9).reduce((acc, input) => acc + (parseInt(input.value) || 0), 0);
      const gross10to18 = hoyos.slice(9, 18).reduce((acc, input) => acc + (parseInt(input.value) || 0), 0);

      // Calcular el Total Gross (1-18)
      const totalGross = gross1to9 + gross10to18;

      // Calcular el Total Neto (Gross Total - Handicap)
      const totalNeto = totalGross - handicap;

      // Actualizar los valores de los totales en el HTML
      document.getElementById('totalGross1to9').textContent = gross1to9;
      document.getElementById('totalGross10to18').textContent = gross10to18;
      document.getElementById('totalGross').textContent = totalGross;
      document.getElementById('totalNeto').textContent = totalNeto;

      // Activar el botÃ³n de guardar si todos los hoyos tienen valores
      const allFieldsFilled = hoyos.every(input => input.value.trim() !== "");
      const validGross = totalGross > 0 && totalNeto > 0;
      document.getElementById('guardarBtn').disabled = !(allFieldsFilled && validGross);
    }

    // Inicializar
    cargarCanchas();

/*---------------------------------------
// ðŸ”¸ ASYNC BUSCA ULTIMA FECHA               
-----------------------------------------*/
    async function buscaUltimaFecha() {
      try {
        const response = await fetch(`/leerUltimaFecha`);

        if (response.ok) {
          const data = await response.json();
          return data; // Devuelve los datos obtenidos si la respuesta es exitosa
        } else {
          console.error(
            "Error en la respuesta:",
            response.status,
            response.statusText
          );
          return null;
        }
      } catch (error) {
        console.error("Error en la solicitud:", error);
        return null;
      }
    }

/*---------------------------------------
// ðŸ”¸ BUSCA ULTIMA FECHA               
-----------------------------------------*/
    buscaUltimaFecha().then((ultimaFecha) => {
      if (ultimaFecha) {
        document.getElementById("ultFecha").value = ultimaFecha.textoFecha;
        document.getElementById("ultNumero").value = ultimaFecha.fec;
        fec = ultimaFecha.fec;
        fecFullTabla = ultimaFecha.fechaFull;
      } else {
        alert("No se encontrÃ³ ninguna fecha");
      }
    });

  </script>
</body>

</html>